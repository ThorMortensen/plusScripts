#!/bin/bash
. plusScriptsPaths


print_title() {
    echo -e "\033[1;4;36m$1\033[0m"
}

print_link() {
    echo -e "\033[1;4;34m$1\033[0m"
}

echo "Fetching info from $@ ..."


fw_shas=$(auth-wrapper ssh support@$@ "sudo cc-hal updatecli versions") 
bootloader=$(echo "$fw_shas" | awk -F': ' '/bootloader/ {print $2}')
app=$(echo "$fw_shas" | awk -F': ' '/app/ {print $2}')
kernel=$(echo "$fw_shas" | awk -F': ' '/kernel/ {print $2}')
rootfs=$(echo "$fw_shas" | awk -F': ' '/rootfs/ {print $2}')
cpu_id=$(auth-wrapper ssh support@$@ "cc-info" | grep 'cpu_id' | awk -F': ' '{print $2}')

json_output=$(plus-lookup --bootloader "$bootloader" --app "$app" --kernel "$kernel" --rootfs "$rootfs" --device-id "$cpu_id")
fw_id=$(echo "$json_output" | jq -r '.fw_id')
rg_name=$(echo "$json_output" | jq -r '.rg_name')
rg_id=$(echo "$json_output" | jq -r '.rg_id')
sim_id=$(echo "$json_output" | jq -r '.sim_id')
vin=$(echo "$json_output" | jq -r '.vin')
config_name=$(echo "$json_output" | jq -r '.config_name')
vehicle_id=$(echo "$json_output" | jq -r '.vehicle_id')

device_type=$(auth-wrapper ssh support@$@ "hostname") 
momondo_addr=$(auth-wrapper ssh support@$@ "$(cat $PS_DIR_WORKERS/device-info-remote-cmd.sh)") 
state=$(auth-wrapper ssh support@$@ "sudo cc-pmcli gpios") 
gps=$(auth-wrapper ssh support@$@ "sudo cc-gpscli location")


print_title "Device info:"
echo "Type: $device_type"
echo "DevID: $cpu_id"
echo "VclID: $vehicle_id"
print_title "SW versions:" 
echo "FW ID: $fw_id"
echo "RollGr: $rg_name"
echo "RollID: $rg_id"
echo "App: ${app:0:10}"
echo "Rfs: ${rootfs:0:10}"
echo "Knl: ${kernel:0:10}"
echo "Bld: ${bootloader:0:10}"
print_title "Onomondo addr:"
echo "$momondo_addr"
echo "SIM ID: $sim_id"
print_title "State:"
echo "PWR: $state"
echo "GPS: $gps"
echo "VIN: $vin"
echo "Config: $config_name"
print_title "Links:"
echo Workshop: $(print_link "https://workshop.connectedcars.io/debug/vehicles/$vehicle_id")
echo Onomondo: $(print_link "https://app.onomondo.com/sims/$sim_id")
