#!/bin/bash
. plusScriptsPaths

establised=false

# Define a function to handle the SIGINT signal
handle_sigint() {
    stop_spinner
    if [ "$establised" = true ]; then
        auth-wrapper ssh -S "$socket_path" -O exit support@"$device" >/dev/null 2>&1
    fi
    exit 1
}
trap handle_sigint SIGINT

to_markdown=false

DEVICE_CACHE_DIR="$PS_DIR_PERSIST/DEVICE_CACHE"
declare -A prev_values
declare -A new_values
cache_file=""

sanitize_cache_name() {
    echo "$1" | tr '/:\\ ' '__'
}

load_cache() {
    local file=$1
    if [ -f "$file" ]; then
        while IFS='=' read -r key value; do
            prev_values["$key"]="$value"
        done < "$file"
    fi
}

color_if_changed() {
    local key=$1
    local value=$2

    if [ "$to_markdown" = true ]; then
        printf '%s' "$value"
        return
    fi

    local prev="${prev_values[$key]}"
    if [ -n "$prev" ] && [ "$prev" != "$value" ]; then
        printf '\033[1;33m%s\033[0m' "$value"
    else
        printf '%s' "$value"
    fi
}

print_field() {
    local key=$1
    local label=$2
    local value=$3
    new_values["$key"]="$value"
    local formatted
    formatted=$(color_if_changed "$key" "$value")
    echo "$label$formatted"
}

update_cache() {
    local file=$1
    mkdir -p "$(dirname "$file")"
    {
        for key in "${!new_values[@]}"; do
            printf '%s=%s\n' "$key" "${new_values[$key]}"
        done
    } > "$file"
}

if [ "$1" == "--md" ]; then
  to_markdown=true
  shift
fi

device=$1

if [ -z "$device" ]; then
  select_port 
  device="$SELECTED_DEVICE"
fi

start_spinner "Fetching device info from $device"
socket_path="/tmp/ssh_socket_$device"

# Establish a master SSH connection
auth-wrapper ssh -MNf -S "$socket_path" -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null support@"$device"
establised=true

# Fetch device info
fw_shas=$(auth-wrapper ssh -S "$socket_path" support@"$device" "sudo cc-hal updatecli versions")
bootloader=$(echo "$fw_shas" | awk -F': ' '/bootloader/ {print $2}')
app=$(echo "$fw_shas" | awk -F': ' '/app/ {print $2}')
kernel=$(echo "$fw_shas" | awk -F': ' '/kernel/ {print $2}')
rootfs=$(echo "$fw_shas" | awk -F': ' '/rootfs/ {print $2}')
cpu_id=$(auth-wrapper ssh -S "$socket_path" support@"$device" "cc-info" | grep 'cpu_id' | awk -F': ' '{print $2}')
# using_debug_conf=$(auth-wrapper ssh -S "$socket_path" support@"$device" "cat /data/conf/ccapp.env 2>/dev/null | grep USE_DEBUG_CONFIG=1")
internal_state=$(auth-wrapper ssh -S "$socket_path" support@"$device" "zcat /data/internal_state.json.gz")

# Check for debug config in both file paths
using_debug_conf=$(auth-wrapper ssh -S "$socket_path" support@"$device" "
    if grep -q 'USE_DEBUG_CONFIG=1' /data/conf/ccapp.env 2>/dev/null || grep -q 'USE_DEBUG_CONFIG=1' /data/env/ccapp.env 2>/dev/null; then
        echo 'USE_DEBUG_CONFIG=1'
    fi
")


tester_present=$(echo "$internal_state" | jq -r '
  .testerDetection | 
  to_entries | 
  map(select(.value.isBlocked == true) | .key) |
  if length == 0 then "None" else "PRESSENT " + join(",") end
')

if [ "$tester_present" = "None" ]; then
  tester_detect_state=$(auth-wrapper ssh -S "$socket_path" support@"$device" "sudo cat /data/HAL_CAN_TESTER_DETECTOR_STATE.json")

  tester_present=$(echo "$tester_detect_state" | jq -r '
    if .blocked == true then "PRESSENT HAL" 
    elif .garage_mode == true then "GARAGE-MODE"
    else "None" 
    end
  ')
fi

# Extract only the valid JSON block from the output
json_output=$(plus-lookup --bootloader "$bootloader" --app "$app" --kernel "$kernel" --rootfs "$rootfs" --device-id "$cpu_id" | awk '/^{/,/}$/' | jq -c '.')

# Check if the JSON extraction was successful
if [ -z "$json_output" ]; then
    echo "Error: Failed to extract valid JSON from plus-lookup output."
    exit 1
fi

fw_id=$(echo "$json_output" | jq -r '.fw_id')
rg_name=$(echo "$json_output" | jq -r '.rg_name')
rg_id=$(echo "$json_output" | jq -r '.rg_id')
sim_provider=$(echo "$json_output" | jq -r '.sim_provider')
sim_provider_link=$(echo "$json_output" | jq -r '.sim_provider_link')
sim_id=$(echo "$json_output" | jq -r '.sim_id')
vin=$(echo "$json_output" | jq -r '.vin')
config_name=$(echo "$json_output" | jq -r '.config_name')
vehicle_id=$(echo "$json_output" | jq -r '.vehicle_id')
sticker_id=$(echo "$json_output" | jq -r '.sticker_id')

device_type=$(auth-wrapper ssh -S "$socket_path" support@"$device" "hostname")
ip_addr=$(auth-wrapper ssh -S "$socket_path" support@"$device" "$(cat $PS_DIR_WORKERS/device-info-remote-cmd.sh)")
state=$(auth-wrapper ssh -S "$socket_path" support@"$device" "sudo cc-pm2cli get_gpios")
gps=$(auth-wrapper ssh -S "$socket_path" support@"$device" "sudo cc-gps2cli location")
gps_fix=$(echo "$gps" | awk 'match($0,/fix:[[:space:]]*([A-Za-z]+)/,m){print m[1]; exit}')
if [ -z "$gps_fix" ]; then
    gps_fix="unknown"
fi
region=$(auth-wrapper ssh -S "$socket_path" support@"$device" "if [ -f /data/conf/region ]; then cat /data/conf/region; else echo None; fi")
boot_slots=$(auth-wrapper ssh -S "$socket_path" support@"$device" "sudo fw_printenv slot_rootfs slot_bootfs 2>/dev/null")
slot_rootfs=$(echo "$boot_slots" | awk -F= '/^slot_rootfs=/ {print $2}')
slot_bootfs=$(echo "$boot_slots" | awk -F= '/^slot_bootfs=/ {print $2}')

if auth-wrapper ssh -S "$socket_path" support@"$device" "test -f /data/accel2-calibration.json"; then
    calibrated="Yes"
else
    calibrated="No"
fi

if [[ $using_debug_conf == *"USE_DEBUG_CONFIG=1"* ]]; then
    debug_path=$(auth-wrapper ssh -S "$socket_path" support@"$device" "
        grep DEBUG_CONFIG_PATH /data/conf/ccapp.env 2>/dev/null ||
        grep DEBUG_CONFIG_PATH /data/env/ccapp.env 2>/dev/null
    ")
    config_name="Debug-config at: ${debug_path#*=}"
fi

# Close the master SSH connection
auth-wrapper ssh -S "$socket_path" -O exit support@"$device" >/dev/null 2>&1
stop_spinner

cache_name_source=$cpu_id
if [ -z "$cache_name_source" ] || [ "$cache_name_source" = "null" ]; then
  cache_name_source=$device
fi
cache_file="$DEVICE_CACHE_DIR/$(sanitize_cache_name "$cache_name_source")"
load_cache "$cache_file"

if [[ "$2" != "--full" ]]; then
  app=${app:0:10}
  bootloader=${bootloader:0:10}
  kernel=${kernel:0:10}
  rootfs=${rootfs:0:10}
fi


if [ "$to_markdown" = true ]; then
  echo "\`\`\`"
fi

print_title "~~Device info~~"
print_field "Type"   "Type:   " "$device_type"
print_field "DevID"  "DevID:  " "$cpu_id"
print_field "VclID"  "VclID:  " "$vehicle_id"
print_field "StkrID" "StkrID: " "$sticker_id"
print_title "~~SW versions~~"
print_field "FW_ID"  "FW ID:  " "$fw_id"
print_field "RollGr" "RollGr: " "$rg_name"
print_field "RollID" "RollID: " "$rg_id"
print_field "App"    "App:    " "${app}"
print_field "Rfs"    "Rfs:    " "${rootfs}"
print_field "Knl"    "Knl:    " "${kernel}"
print_field "Bld"    "Bld:    " "${bootloader}"
print_title "~~IP~~"
print_field "Add"   "Add:    " "$ip_addr"
print_field "SimID" "SimID:  " "$sim_id"
print_title "~~State~~"
print_field "PWR"    "PWR:    " "$state"
print_field "GPS"    "Fix:    " "$gps_fix"
print_field "VIN"    "VIN:    " "$vin"
print_field "Config" "Config: " "$config_name"
print_field "BSlots" "BSlots: " "rootfs: ${slot_rootfs:-unknown}, bootfs: ${slot_bootfs:-unknown}"
print_field "Tester" "Tester: " "$tester_present"
print_field "Calib"  "Calib:  " "$calibrated"
print_field "Region" "Region: " "$region"
print_title "~~Links~~"
if [ "$vehicle_id" != "null" ]; then
  echo " Workshop: $(print_link "https://workshop.connectedcars.io/debug/vehicles/$vehicle_id")"
else
  echo " Workshop: $(print_link "https://workshop.connectedcars.io/debug/units/$cpu_id")"
fi

if [ "$sim_provider" != "null" ]; then
  echo " $sim_provider: $(print_link "$sim_provider_link")"
fi

if [ "$to_markdown" = true ]; then
  echo "\`\`\`"
fi

update_cache "$cache_file"

# if [ "$to_markdown" = true ]; then
#   echo ""
#   echo "\`\`\`"
#   echo "$sticker_id"
#   echo "$cpu_id"
#   echo "$sim_id"
#   echo "$ip_addr"
#   echo "\`\`\`"
# fi





# #!/bin/bash
# . plusScriptsPaths

# # Define a function to handle the SIGINT signal
# handle_sigint() {
#     stop_spinner
#     auth-wrapper ssh -S "$socket_path" -O exit support@"$device"
#     exit 1
# }
# trap handle_sigint SIGINT

# to_markdown=false

# if [ "$1" == "--wiki" ]; then
#   to_markdown=true
#   shift
# fi

# device=$1

# if [ -z "$device" ]; then
#   select_port 
#   device="$SELECTED_DEVICE"
# fi

# start_spinner "Fetching device info from $device"
# socket_path="/tmp/ssh_socket_$device"

# # Establish a master SSH connection
# auth-wrapper ssh -MNf -S "$socket_path" -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null support@"$device"

# # Fetch device info
# info=$(auth-wrapper ssh -S "$socket_path" support@"$device" "
#   sudo cc-hal updatecli versions;
#   cc-info;
#   cat /data/conf/ccapp.env 2>/dev/null | grep USE_DEBUG_CONFIG=1;
#   hostname;
#   sudo cc-pmcli gpios;
#   sudo cc-gpscli location;
#   $(cat $PS_DIR_WORKERS/device-info-remote-cmd.sh)
# ")

# fw_shas=$(echo "$info" | sed -n '1,/^$/p')
# cpu_id=$(echo "$info" | grep 'cpu_id' | awk -F': ' '{print $2}')
# using_debug_conf=$(echo "$info" | grep 'USE_DEBUG_CONFIG=1')
# device_type=$(echo "$info" | grep -E -m 1 '^([[:alnum:]]|-)+$')
# state=$(echo "$info" | grep -E -A1 '^sudo cc-pmcli gpios$' | tail -n1)
# gps=$(echo "$info" | grep -E -A1 '^sudo cc-gpscli location$' | tail -n1)
# ip_addr=$(echo "$info" | grep -E -A1 '^([[:alnum:]]|-)+$' | tail -n1)

# bootloader=$(echo "$fw_shas" | awk -F': ' '/bootloader/ {print $2}')
# app=$(echo "$fw_shas" | awk -F': ' '/app/ {print $2}')
# kernel=$(echo "$fw_shas" | awk -F': ' '/kernel/ {print $2}')
# rootfs=$(echo "$fw_shas" | awk -F': ' '/rootfs/ {print $2}')

# json_output=$(plus-lookup --bootloader "$bootloader" --app "$app" --kernel "$kernel" --rootfs "$rootfs" --device-id "$cpu_id")
# fw_id=$(echo "$json_output" | jq -r '.fw_id')
# rg_name=$(echo "$json_output" | jq -r '.rg_name')
# rg_id=$(echo "$json_output" | jq -r '.rg_id')
# sim_provider=$(echo "$json_output" | jq -r '.sim_provider')
# sim_provider_link=$(echo "$json_output" | jq -r '.sim_provider_link')
# sim_id=$(echo "$json_output" | jq -r '.sim_id')
# vin=$(echo "$json_output" | jq -r '.vin')
# config_name=$(echo "$json_output" | jq -r '.config_name')
# vehicle_id=$(echo "$json_output" | jq -r '.vehicle_id')
# sticker_id=$(echo "$json_output" | jq -r '.sticker_id')

# if [[ $using_debug_conf == *"USE_DEBUG_CONFIG=1"* ]]; then
#     debug_path=$(auth-wrapper ssh -S "$socket_path" support@"$device" "cat /data/conf/ccapp.env | grep DEBUG_CONFIG_PATH")
#     config_name="Debug-config at: ${debug_path#*=}"
# fi

# # Close the master SSH connection
# auth-wrapper ssh -S "$socket_path" -O exit support@"$device"
# stop_spinner

# if [[ "$2" != "--full" ]]; then
#   app=${app:0:10}
#   bootloader=${bootloader:0:10}
#   kernel=${kernel:0:10}
#   rootfs=${rootfs:0:10}
# fi

# print_title "Device info:"
# echo "Type: $device_type"
# echo "DevID: $cpu_id"
# echo "VclID: $vehicle_id"
# echo "StkrID: $sticker_id"
# print_title "SW versions:"
# echo "FW ID: $fw_id"
# echo "RollGr: $rg_name"
# echo "RollID: $rg_id"
# echo "App: ${app}"
# echo "Rfs: ${rootfs}"
# echo "Knl: ${kernel}"
# echo "Bld: ${bootloader}"
# print_title "IP addr:"
# echo "$ip_addr"
# echo "SimID: $sim_id"
# print_title "State:"
# echo "PWR: $state"
# echo "GPS: $gps"
# echo "VIN: $vin"
# echo "Config: $config_name"
# print_title "Links:"
# if [ "$vehicle_id" != "null" ]; then
#   echo Workshop: $(print_link "https://workshop.connectedcars.io/debug/vehicles/$vehicle_id")
# else
#   echo Workshop: $(print_link "https://workshop.connectedcars.io/debug/units/$cpu_id")
# fi

# if [ "$sim_provider" != "null" ]; then
#   echo "$sim_provider: $(print_link "$sim_provider_link")"
# fi

# if [ "$to_markdown" = true ]; then
#   echo ""
#   echo "\`\`\`"
#   echo "$sticker_id"
#   echo "$cpu_id"
#   echo "$sim_id"
#   echo "$ip_addr"
#   echo "\`\`\`"
# fi
