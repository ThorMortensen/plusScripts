#!/bin/bash


install() {
  echo "Command not supported: $1"
  echo "Move to the root of the part you want to install and run:"
  echo "cargo install --path ."
}

build() {
  CARGO_PROFILE=fast-release ./build-all.sh
}




deploy() {
  echo "Deploying to $2"
  
  if [ -z "$3" ]; then
    build "$@"
    ./ccupd_rootfs.sh $2
  else 
    source /usr/local/oecore-x86_64/environment-setup-cortexa7t2hf-neon-oe-linux-gnueabi || exit 1
    cargo build --target armv7-unknown-linux-gnueabihf --profile fast-release  || exit 1
    # +scp-to-device port2 target/armv7-unknown-linux-gnueabihf/fast-release/$3 
    auth-wrapper rsync -avz "target/armv7-unknown-linux-gnueabihf/fast-release/$3" "$2":/data/support/"$3" && dye bold green "Deployed $3" || dye bold red  "No file called $3. Deployment failed."
  fi


}

test() {
  cargo test
}

pre_push() {
  cargo clippy --release --all-targets --all-features --locked
  checks cargo-all
}

echo "1: $1"
echo "2: $2"
echo "3: $3"
echo "4: $4"

case "$1" in
  install)
    install "$@"
    ;;
  build)
    build "$@"
    ;;
  deploy)
    deploy "$@"
    ;;
  test)
    test "$@"
    ;;
  pre_push)
    pre_push "$@"
    ;;    
  *)
    echo "Command not supported: $1"
    exit 1
    ;;
esac
